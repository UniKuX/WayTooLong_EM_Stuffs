Bootstrap: docker
From: ubuntu:20.04

%labels
    Author YourName
%files
    fltk-1.3.3-source.tar.gz /opt/fltk-1.3.3-source.tar.gz

%environment
    export PATH=/usr/local/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    export CUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda

%post
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install -y \
        build-essential \
        cmake \
        git \
        wget \
        libfftw3-dev \
        libtiff-dev \
        libjpeg-dev \
        libpng-dev \
        libboost-all-dev \
        libx11-dev \
        libxext-dev \
        libgl1-mesa-dev \
        libgoogle-glog-dev \
        libgflags-dev \
        
        # (adjust cuda toolkit version according to your GPU and drivers)

    # Add NVIDIA CUDA 11.2 repository and install toolkit
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin
    mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600
    wget https://developer.download.nvidia.com/compute/cuda/11.2.2/local_installers/cuda-repo-ubuntu2004-11-2-local_11.2.2-460.32.03-1_amd64.deb
    dpkg -i cuda-repo-ubuntu2004-11-2-local_11.2.2-460.32.03-1_amd64.deb
    apt-key add /var/cuda-repo-ubuntu2004-11-2-local/7fa2af80.pub
    apt-get update
    apt-get install -y cuda-toolkit-11-2

    # Clone RELION 3.0.8 source
    cd /opt
    rm -rf relion
    git clone --branch 3.0.8 https://github.com/3dem/relion.git

    # Build RELION
    cd relion
    mkdir build
    cd build

    cmake \
      -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_INSTALL_PREFIX=/usr/local/relion-3.0.8 \
      -DFFTWF_LIBRARY=/usr/lib/x86_64-linux-gnu/libfftw3f.so \
      -DFFTWF_INCLUDE_DIR=/usr/include \
      -DFFTWD_LIBRARY=/usr/lib/x86_64-linux-gnu/libfftw3.so \
      -DFFTWD_INCLUDE_DIR=/usr/include \
      -DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda \
      ..

    cp /opt/fltk-1.3.3-source.tar.gz /opt/relion/external/fltk/

    make -j4
    make install

%test
    relion --version || true